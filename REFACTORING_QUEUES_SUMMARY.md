# –†–µ–∑—é–º–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –æ—á–µ—Ä–µ–¥–µ–π –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ë–î
**–§–∞–π–ª:** `scripts/check_queues.py`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –æ—á–µ—Ä–µ–¥–∏
docker exec -it realty_web python scripts/check_queues.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç
docker exec -it realty_web python scripts/check_queues.py AAA052

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—ä–µ–∫—Ç –∏ –∞–∫–∫–∞—É–Ω—Ç
docker exec -it realty_web python scripts/check_queues.py AAA052 +79996731791
```

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤
- –ó–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –±–æ—Ç–∞ (`publication_queues`)
- –ó–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—è—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (`account_publication_queues`)
- –°—Ç–∞—Ç—É—Å—ã, –æ—à–∏–±–∫–∏, –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
**–§–∞–π–ª:** `app/utils/account_publication_utils.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 5 —Ä–µ–∂–∏–º–æ–≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤:
  - `safe`: 10 –º–∏–Ω—É—Ç + –¥–∂–∏—Ç—Ç–µ—Ä (1-99 —Å–µ–∫)
  - `normal`: 5 –º–∏–Ω—É—Ç + –¥–∂–∏—Ç—Ç–µ—Ä
  - `aggressive`: 2 –º–∏–Ω—É—Ç—ã + –¥–∂–∏—Ç—Ç–µ—Ä
  - `smart`: —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å (8:00-22:00 –ú–°–ö, 14 —á–∞—Å–æ–≤)
  - `fix`: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∏–∑ `TelegramAccount.fix_interval_minutes`) + –¥–∂–∏—Ç—Ç–µ—Ä
- ‚úÖ –î–∂–∏—Ç—Ç–µ—Ä –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º —Ä–µ–∂–∏–º–∞–º (–∫—Ä–æ–º–µ smart)

### 3. –°–æ–∑–¥–∞–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
**–§–∞–π–ª:** `app/utils/duplicate_checker.py`

**–§—É–Ω–∫—Ü–∏—è:** `check_duplicate_publication()`

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:**
- 4 —Ç–∏–ø–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è–º–∏:
  - `manual_bot` - —Ä—É—á–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞
  - `manual_account` - —Ä—É—á–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç
  - `autopublish_bot` - –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞
  - `autopublish_account` - –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç
- –û—Ç–¥–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ (`admin_bypass`)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤:** `SystemSetting` —Å –∫–ª—é—á–æ–º `allow_duplicates`:
```json
{
  "manual_bot": false,
  "manual_account": false,
  "autopublish_bot": false,
  "autopublish_account": false,
  "admin_bypass": false
}
```

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å TelegramAccount
**–§–∞–π–ª:** `app/models/telegram_account.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ:**
- `fix_interval_minutes` (Integer, nullable) - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Ä–µ–∂–∏–º–∞ 'fix'

### 5. –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
**–§–∞–π–ª:** `migrations/versions/add_fix_interval_to_telegram_account.py`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É `fix_interval_minutes` –≤ —Ç–∞–±–ª–∏—Ü—É `telegram_accounts`

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```bash
docker exec -it realty_web alembic upgrade head
```

### 6. –°–æ–∑–¥–∞–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ
**–§–∞–π–ª:** `DIAGNOSTIC_QUEUES.md`

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã Celery
- –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î —á–µ—Ä–µ–∑ SQL
- –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤—Ä—É—á–Ω—É—é
- –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

## üîÑ –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–¥–µ–ª–∞—Ç—å

### 1. –û–±–Ω–æ–≤–∏—Ç—å `workers/tasks.py`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `duplicate_checker.check_duplicate_publication()` –≤–º–µ—Å—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é `calculate_scheduled_times_for_account()` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π `fix_interval_minutes`
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: —Å–Ω–∞—á–∞–ª–∞ –≤—Å–µ —á–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, –ø–æ—Ç–æ–º –≤—Ç–æ—Ä–æ–≥–æ

### 2. –û–±–Ω–æ–≤–∏—Ç—å `schedule_daily_autopublish()`
- ‚úÖ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º: —Å–Ω–∞—á–∞–ª–∞ –≤—Å–µ —á–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, –ø–æ—Ç–æ–º –≤—Ç–æ—Ä–æ–≥–æ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `fix_interval_minutes` –∏–∑ `TelegramAccount` –¥–ª—è —Ä–µ–∂–∏–º–∞ 'fix'

### 3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä—É—á–Ω—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç—ã
- ‚úÖ –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è —Ä—É—á–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—Ç—å rate limiter —á–µ—Ä–µ–∑ `get_rate_limit_status()`
- ‚úÖ –ï—Å–ª–∏ rate limit - –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –Ω–∞ 30 –º–∏–Ω—É—Ç + –¥–∂–∏—Ç—Ç–µ—Ä
- ‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –∑–∞–¥–∞—á–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É –∞–∫–∫–∞—É–Ω—Ç–∞

### 4. –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å SystemSetting –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `allow_duplicates`
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
```bash
docker compose ps
# –ï—Å–ª–∏ celery_worker –∏–ª–∏ celery_beat –≤ —Å—Ç–∞—Ç—É—Å–µ "Restarting" - —Å–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏:
docker logs realty_celery_worker --tail 100
docker logs realty_celery_beat --tail 100
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ AAA052
```bash
docker exec -it realty_web python scripts/check_queues.py AAA052 +79996731791
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ SQL
```bash
docker exec -it realty_postgres psql -U realty_user -d realty_db

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏
SELECT * FROM autopublish_configs WHERE object_id = 'AAA052';

# –û—á–µ—Ä–µ–¥–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
SELECT aq.*, ta.phone, ta.mode, ta.is_active, ta.fix_interval_minutes
FROM account_publication_queues aq
JOIN telegram_accounts ta ON aq.account_id = ta.account_id
WHERE aq.object_id = 'AAA052'
ORDER BY aq.scheduled_time;
```

### –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤—Ä—É—á–Ω—É—é
```bash
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π –∞–∫–∫–∞—É–Ω—Ç–æ–≤
docker exec -it realty_celery_worker celery -A workers.celery_app call workers.tasks.process_account_autopublish

# –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –Ω–∞ –¥–µ–Ω—å
docker exec -it realty_celery_worker celery -A workers.celery_app call workers.tasks.schedule_daily_autopublish
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è - `realty_celery_worker` (–Ω–µ `realty_worker`!)

2. **–ú–∏–≥—Ä–∞—Ü–∏—è:** –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
   ```bash
   docker exec -it realty_web alembic upgrade head
   ```

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Celery:** –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ `workers/tasks.py` –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å:
   ```bash
   docker compose restart celery_worker celery_beat
   ```

4. **–õ–æ–≥–∏:** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ:
   - `logs_server/test_celery.log`
   - `logs_server/test_telethon.log`
   - `logs_server/test_errors.log`

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
2. –û–±–Ω–æ–≤–∏—Ç—å `workers/tasks.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —É—Ç–∏–ª–∏—Ç
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–±—ä–µ–∫—Ç–µ AAA052
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä—É—á–Ω—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç—ã
5. –î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

