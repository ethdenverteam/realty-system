# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

## 1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤ app/__init__.py

**–ü—Ä–æ–±–ª–µ–º–∞:** `NameError: name 'request' is not defined`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ò–º–ø–æ—Ä—Ç `request` –∏–∑ `flask` –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ –Ω–∞—á–∞–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏ `handle_exception()`

**–§–∞–π–ª:** `app/__init__.py`

## 2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¥–ª—è –∞–¥–º–∏–Ω–∞: –æ–±—Ö–æ–¥ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/admin/dashboard/settings`
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `SystemSetting` —Å –∫–ª—é—á–æ–º `admin_bypass_time_limit`
- –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –∏ –∞–∫–∫–∞—É–Ω—Ç—ã –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è 8:00-22:00 –ú–°–ö)
- –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è

**–§–∞–π–ª—ã:**
- `frontend/src/pages/admin/Settings.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ UI
- `app/routes/admin_routes.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã endpoints:
  - `GET /admin/dashboard/settings` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É `admin_bypass_time_limit`
  - `PUT /admin/dashboard/settings/admin-bypass-time-limit` - –æ–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É
- `workers/tasks.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `publish_to_telegram()` –¥–ª—è –±–æ—Ç–∞

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. –ü—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (`publish_to_telegram`) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `admin_bypass_time_limit`
   - –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω –∏–ª–∏ –Ω–µ—Ç)
   - –ï—Å–ª–∏ –∞–¥–º–∏–Ω –ò –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
2. –î–ª—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ –Ω—É–∂–Ω–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ, —Ç.–∫. –∑–∞–¥–∞—á–∏ —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏

## 3. üìã –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ Docker

### –ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç –ª–æ–≥–∏:

**1. `docker compose up -d`:**
```
‚úî Container realty_celery_worker Recreated
‚úî Container realty_celery_beat Recreated
```
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω—ã (–æ–±–Ω–æ–≤–ª–µ–Ω—ã)
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã

**2. `docker logs realty_celery_worker`:**
```
celery@ce79fd9c20cd ready.
[tasks]
  . workers.tasks.process_account_autopublish
  . workers.tasks.process_autopublish
  ...
```
- ‚úÖ Celery worker —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω
- ‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã
- ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –æ—Ç root - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –ª—É—á—à–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**3. `docker logs realty_celery_beat`:**
```
beat: Starting...
Current schedule:
<ScheduleEntry: schedule-daily-autopublish-8-msk ...>
<ScheduleEntry: process-account-autopublish-every-minute ...>
```
- ‚úÖ Celery beat —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω
- ‚úÖ –í—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã

**4. `scripts/check_queues.py AAA052 +79996731791`:**
```
‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ AAA052
‚ùå –ù–µ—Ç –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏ –±–æ—Ç–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ AAA052
‚ùå –ù–µ—Ç –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—è—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ AAA052
```
- –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
- –ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É, –Ω—É–∂–Ω–æ:
  1. –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—é –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ AAA052
  2. –ó–∞–ø—É—Å—Ç–∏—Ç—å `schedule_daily_autopublish`
  3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞

**5. `celery call workers.tasks.schedule_daily_autopublish`:**
```
7ea1876d-3f87-439d-8c60-3869333b0bdd
```
- ‚úÖ –ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å
- ID –∑–∞–¥–∞—á–∏ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ

## 4. üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

### –®–∞–≥ 1: –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—é –¥–ª—è –æ–±—ä–µ–∫—Ç–∞
–ß–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–ª–∏ API –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—é –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ AAA052

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á–∏
```bash
docker exec -it realty_celery_worker celery -A workers.celery_app call workers.tasks.schedule_daily_autopublish
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–µ—Ä–µ–¥–∏
```bash
docker exec -it realty_web python scripts/check_queues.py AAA052 +79996731791
```

### –®–∞–≥ 4: –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—á–µ—Ä–µ–¥–∏
```bash
docker exec -it realty_celery_worker celery -A workers.celery_app call workers.tasks.process_account_autopublish
```

## 5. ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û—à–∏–±–∫–∞ 405 Method Not Allowed** –≤ –ª–æ–≥–∞—Ö - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —ç—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º endpoints (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–º—É API)

2. **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ Celery** - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –ª—É—á—à–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `--uid` –≤ docker-compose.yml)

3. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î** - –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:
   ```bash
   docker exec -it realty_web alembic upgrade head
   ```

4. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π**:
   ```bash
   docker compose restart web celery_worker celery_beat
   ```

