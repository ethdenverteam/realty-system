# Исправления проблем

## 1. Ошибка "database is locked"

**Проблема:** Telethon использует SQLite для хранения сессий, и когда несколько процессов пытаются одновременно получить доступ к одному файлу сессии, возникает ошибка "database is locked".

**Решение:**
- Добавлена система блокировок для файлов сессий через `threading.Lock`
- Каждый номер телефона имеет свою блокировку
- Добавлены повторные попытки (3 попытки с экспоненциальной задержкой)
- Улучшена обработка ошибок с понятными сообщениями

**Изменения в `app/utils/telethon_client.py`:**
- Добавлена функция `get_session_lock()` для получения блокировки для номера
- Все функции работы с сессиями (`get_chats`, `send_test_message`, `send_object_message`) теперь используют блокировки
- Добавлена обработка ошибок "database is locked" с автоматическими повторами

## 2. Улучшены уведомления о rate limit

**Проблема:** Пользователь не понимал, почему не может отправить сообщение.

**Решение:**
- Добавлены понятные сообщения на русском языке
- Указана причина блокировки (минутный или часовой лимит)
- Показано время ожидания в удобном формате (минуты и секунды)

**Примеры сообщений:**
- "Превышен лимит отправки сообщений. В эту минуту уже было отправлено сообщение. Подождите 45 сек перед следующей отправкой."
- "Превышен лимит отправки сообщений. Превышен часовой лимит (60 сообщений в час). Подождите 15 мин 30 сек перед следующей отправкой."

**Изменения:**
- `app/utils/telethon_client.py` - проверка rate limit перед отправкой с понятными ошибками
- `app/routes/objects.py` - улучшены сообщения об ошибках rate limit в API

## 3. Проблема с публикацией объекта

**Проверьте:**
1. Убедитесь, что аккаунт авторизован (проверьте статус в списке аккаунтов)
2. Убедитесь, что чаты загружены (нажмите "Обновить чаты")
3. Проверьте rate limit (не должно быть отправлено сообщение в последнюю минуту)
4. Проверьте логи на наличие ошибок

**Если проблема сохраняется:**
- Проверьте логи в `logs_server/test_telethon.log` и `logs_server/test_errors.log`
- Убедитесь, что файл сессии существует и не поврежден
- Попробуйте переподключить аккаунт

## Технические детали

### Блокировки сессий
```python
# Каждый номер имеет свою блокировку
_session_locks: Dict[str, threading.Lock] = {}

def get_session_lock(phone: str) -> threading.Lock:
    """Get or create a lock for a specific phone number's session file"""
    with _session_locks_lock:
        if phone not in _session_locks:
            _session_locks[phone] = threading.Lock()
        return _session_locks[phone]
```

### Повторные попытки
- Максимум 3 попытки
- Экспоненциальная задержка: 1s, 2s, 4s
- Таймаут блокировки: 10 секунд

### Rate Limiting
- 1 сообщение в минуту
- 60 сообщений в час
- Проверка происходит перед каждой отправкой
- Понятные сообщения об ошибках

