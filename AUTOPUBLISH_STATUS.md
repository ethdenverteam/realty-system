# üìä –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ—Ç –∏–º–µ–Ω–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤

## ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SoftTimeLimitExceeded

**–î–ê, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—â–∏—â–µ–Ω:**

1. **–î–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞:**
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ (—Å—Ç—Ä–æ–∫–∞ 1435) - –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–æ –≤—Ö–æ–¥–∞ –≤ `app.app_context()`
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ 1401) - –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ `app.app_context()`

2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö –∑–∞–¥–∞—á:**
   - –ó–∞–¥–∞—á–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ 'processing' –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –≤ 'pending'
   - –ï—Å–ª–∏ –ø–æ–ø—ã—Ç–æ–∫ >= 3, –∑–∞–¥–∞—á–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ 'failed'

3. **–õ–∏–º–∏—Ç—ã –≤—Ä–µ–º–µ–Ω–∏:**
   - `soft_time_limit = 240` —Å–µ–∫—É–Ω–¥ (4 –º–∏–Ω—É—Ç—ã)
   - `hard_time_limit = 300` —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)

## ‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ 8:00 –ú–°–ö

**–î–ê, –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã:**

1. **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:**
   - –ó–∞–¥–∞—á–∞ `schedule_daily_autopublish` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ **05:00 UTC (08:00 –ú–°–ö)**
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: `crontab(minute=0, hour=5)` –≤ `workers/celery_app.py`

2. **–ü–æ—Ä—è–¥–æ–∫ –∑–∞–¥–∞—á –≤ Celery beat:**
   ```
   ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫:
   1. schedule-daily-autopublish-8-msk (05:00 UTC = 08:00 –ú–°–ö) - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á
   2. process-account-autopublish-every-minute (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á
   3. process-autopublish-every-minute (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –±–æ—Ç–∞
   4. process-chat-subscriptions-every-minute (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É) - –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —á–∞—Ç—ã
   5. process-scheduled-publications-every-minute (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É) - –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
   ```

3. **–ß—Ç–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ:**
   - –ó–∞–¥–∞—á–∏ –≤ `account_publication_queues` –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Å:
     - `AutopublishConfig.enabled = True`
     - `accounts_config_json.accounts` —Å –Ω–µ–ø—É—Å—Ç—ã–º–∏ `chat_ids`
     - –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã (`is_active = True`)
     - –ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ —á–∞—Ç—ã (—á–µ—Ä–µ–∑ `TelegramAccountChat` –∏–ª–∏ `owner_account_id`)

## ‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ó–∞–¥–∞—á–∞ Queue 9 –∑–∞—Å—Ç—Ä—è–ª–∞

**–°—Ç–∞—Ç—É—Å:** processing –±–æ–ª–µ–µ 23 –º–∏–Ω—É—Ç (–Ω–∞—á–∞—Ç–æ 2026-02-20 00:13:14)

**–ü—Ä–∏—á–∏–Ω–∞:** 
- –û–±—ä–µ–∫—Ç –ê–ê–ê055 –∏–º–µ–µ—Ç 0 –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ó–∞–¥–∞—á–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ä–∞–Ω–µ–µ, –∫–æ–≥–¥–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±—ã–ª–∞ –¥—Ä—É–≥–æ–π
- –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ —á–∞—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 1112-1130)
- –ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç/—á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∑–∞–¥–∞—á–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ 'failed'

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –°–±—Ä–æ—Å–∏—Ç—å –∑–∞—Å—Ç—Ä—è–≤—à—É—é –∑–∞–¥–∞—á—É
docker exec -it realty_web python scripts/reset_stuck_account_queues.py
```

### 2. –û–±—ä–µ–∫—Ç –ê–ê–ê055 –±–µ–∑ –∞–∫–∫–∞—É–Ω—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0 –∞–∫–∫–∞—É–Ω—Ç–æ–≤, –Ω–æ –µ—Å—Ç—å –∑–∞–¥–∞—á–∞ Queue 9

**–†–µ—à–µ–Ω–∏–µ:** 
- –õ–∏–±–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ –ê–ê–ê055
- –õ–∏–±–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –∑–∞–¥–∞—á—É (–æ–Ω–∞ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è)

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ scripts

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∫—Ä–∏–ø—Ç—ã –Ω–µ –≤–∏–¥–Ω—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ `realty_web`

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `./scripts:/app/scripts` –≤ `docker-compose.yml`

**–î–µ–π—Å—Ç–≤–∏–µ:** –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
```bash
docker-compose restart web
```

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã:
```bash
docker exec -it realty_web python scripts/check_autopublish_readiness.py
docker exec -it realty_web python scripts/diagnose_account_autopublish.py
docker exec -it realty_web python scripts/reset_stuck_account_queues.py
```

## üìã –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ 8:00 –ú–°–ö

- [x] –ó–∞—â–∏—Ç–∞ –æ—Ç SoftTimeLimitExceeded —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [x] –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ (05:00 UTC = 08:00 –ú–°–ö)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã —Å —á–∞—Ç–∞–º–∏)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É —á–∞—Ç–æ–≤ –∫ –∞–∫–∫–∞—É–Ω—Ç–∞–º
- [ ] –°–±—Ä–æ—Å–∏—Ç—å –∑–∞—Å—Ç—Ä—è–≤—à–∏–µ –∑–∞–¥–∞—á–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Celery beat –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø—É—Å–∫–∞

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ü–µ—Ä–µ–¥ 8:00 –ú–°–ö:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å `check_autopublish_readiness.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã —Å –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π –∏–º–µ—é—Ç –∞–∫–∫–∞—É–Ω—Ç—ã —Å —á–∞—Ç–∞–º–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —á–∞—Ç—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∞–∫–∫–∞—É–Ω—Ç–∞–º

2. **–ü–æ—Å–ª–µ 8:00 –ú–°–ö:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Celery beat: `docker logs realty_celery_beat --tail 100`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏: `docker exec -it realty_web python scripts/diagnose_account_autopublish.py`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Celery worker –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∑–∞—Å—Ç—Ä—è–≤—à–∏–µ –∑–∞–¥–∞—á–∏
   - –°–ª–µ–¥–∏—Ç—å –∑–∞ –¥–Ω–µ–≤–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—É–±–ª–∏–∫–∞—Ü–∏–π

