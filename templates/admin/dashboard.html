{% extends "layout.html" %}

{% block title %}–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - Realty System{% endblock %}

{% block header_class %}admin{% endblock %}

{% block header_title %}üîê –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block header_actions %}
    <button class="btn-icon" onclick="logout()" title="–í—ã–π—Ç–∏">
        <i class="bi bi-box-arrow-right"></i>
    </button>
{% endblock %}

{% block content %}
<div id="error" class="alert alert-danger" style="display: none;"></div>

<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-value" id="usersCount">-</div>
        <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="objectsCount">-</div>
        <div class="stat-label">–û–±—ä–µ–∫—Ç–æ–≤</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="publicationsToday">-</div>
        <div class="stat-label">–ü—É–±–ª–∏–∫–∞—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="accountsCount">-</div>
        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
    </div>
</div>

<div class="card">
    <div class="card-header">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
    <div class="d-flex flex-wrap gap-2">
        <a href="/system/admin/dashboard/bot-chats" class="btn btn-primary btn-sm">
            <i class="bi bi-chat-dots"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏
        </a>
        <a href="/system/admin/dashboard/logs" class="btn btn-primary btn-sm">
            <i class="bi bi-file-text"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
        </a>
        <a href="/system/user/dashboard" class="btn btn-secondary btn-sm">
            <i class="bi bi-person"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
    <div id="recentActions" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>
{% endblock %}

{% block bottom_nav %}
<nav class="bottom-nav">
    <a href="/system/admin/dashboard" class="nav-item active">
        <i class="bi bi-house-door"></i>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="/system/admin/dashboard/bot-chats" class="nav-item">
        <i class="bi bi-chat-dots"></i>
        <span>–ß–∞—Ç—ã</span>
    </a>
    <a href="/system/admin/dashboard/logs" class="nav-item">
        <i class="bi bi-file-text"></i>
        <span>–õ–æ–≥–∏</span>
    </a>
    <a href="/system/user/dashboard" class="nav-item">
        <i class="bi bi-person"></i>
        <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
    </a>
</nav>
{% endblock %}

{% block extra_js %}
<script>
    if (!checkAuth()) return;
    
    const user = getUser();
    if (user.web_role !== 'admin') {
        window.location.href = '/system/user/dashboard';
        return;
    }
    
    async function loadStats() {
        try {
            const res = await apiFetch('/admin/dashboard/stats');
            if (res.ok) {
                const stats = await res.json();
                document.getElementById('usersCount').textContent = stats.users_count || 0;
                document.getElementById('objectsCount').textContent = stats.objects_count || 0;
                document.getElementById('publicationsToday').textContent = stats.publications_today || 0;
                document.getElementById('accountsCount').textContent = stats.accounts_count || 0;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
            document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏';
            document.getElementById('error').style.display = 'block';
        }
    }
    
    async function loadRecentActions() {
        try {
            const res = await apiFetch('/admin/dashboard/logs/data?per_page=5');
            if (res.ok) {
                const data = await res.json();
                const logs = data.logs || [];
                
                if (logs.length > 0) {
                    let html = '<div class="table-responsive"><table class="table"><thead><tr><th>–í—Ä–µ–º—è</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th></tr></thead><tbody>';
                    logs.forEach(log => {
                        const date = new Date(log.created_at);
                        html += `<tr>
                            <td>${date.toLocaleString('ru-RU')}</td>
                            <td><code>${log.action}</code></td>
                            <td>${log.user_id || 'System'}</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                    document.getElementById('recentActions').innerHTML = html;
                } else {
                    document.getElementById('recentActions').textContent = '–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π';
                }
            }
        } catch (error) {
            console.error('Error loading actions:', error);
            document.getElementById('recentActions').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        }
    }
    
    loadStats();
    loadRecentActions();
</script>
{% endblock %}

