{% extends "layout.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏ –±–æ—Ç–∞ - Realty System{% endblock %}

{% block header_class %}admin{% endblock %}

{% block header_title %}üí¨ –ß–∞—Ç—ã –±–æ—Ç–∞{% endblock %}

{% block header_actions %}
    <button class="btn-icon" onclick="showAddChatModal()" title="–î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç">
        <i class="bi bi-plus-lg"></i>
    </button>
    <a href="/system/admin/dashboard" class="btn-icon" title="–ù–∞–∑–∞–¥">
        <i class="bi bi-arrow-left"></i>
    </a>
{% endblock %}

{% block content %}
<div id="error" class="alert alert-danger" style="display: none;"></div>
<div id="success" class="alert alert-success" style="display: none;"></div>

<!-- Add Chat Modal -->
<div id="addChatModal" class="card" style="display: none; margin-bottom: 20px;">
    <div class="card-header">–î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç</div>
    <form id="addChatForm">
        <div class="form-group">
            <label class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç</label>
            <input type="text" class="form-control" id="chatLink" placeholder="https://t.me/chatname –∏–ª–∏ @chatname" required>
        </div>
        <div class="form-group">
            <label class="form-label">–¢–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞</label>
            <select class="form-control" id="filterType" onchange="updateFilterFields()">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                <option value="rooms">–ü–æ —Ç–∏–ø—É –∫–æ–º–Ω–∞—Ç</option>
                <option value="district">–ü–æ —Ä–∞–π–æ–Ω—É</option>
                <option value="price">–ü–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É —Ü–µ–Ω</option>
                <option value="custom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π</option>
            </select>
        </div>
        <div id="filterFields"></div>
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button type="button" class="btn btn-secondary" onclick="hideAddChatModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </form>
</div>

<!-- Chats List -->
<div class="card">
    <div class="card-header">–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤</div>
    <div id="chatsList" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>
{% endblock %}

{% block bottom_nav %}
<nav class="bottom-nav">
    <a href="/system/admin/dashboard" class="nav-item">
        <i class="bi bi-house-door"></i>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="/system/admin/dashboard/bot-chats" class="nav-item active">
        <i class="bi bi-chat-dots"></i>
        <span>–ß–∞—Ç—ã</span>
    </a>
    <a href="/system/admin/dashboard/logs" class="nav-item">
        <i class="bi bi-file-text"></i>
        <span>–õ–æ–≥–∏</span>
    </a>
    <a href="/system/user/dashboard" class="nav-item">
        <i class="bi bi-person"></i>
        <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
    </a>
</nav>
{% endblock %}

{% block extra_js %}
<script>
    if (!checkAuth()) return;
    
    const user = getUser();
    if (user.web_role !== 'admin') {
        window.location.href = '/system/user/dashboard';
        return;
    }
    
    let config = null;
    let chats = [];
    
    async function loadConfig() {
        try {
            const res = await apiFetch('/admin/dashboard/bot-chats/config');
            if (res.ok) {
                config = await res.json();
            }
        } catch (error) {
            console.error('Error loading config:', error);
        }
    }
    
    async function loadChats() {
        try {
            const res = await apiFetch('/admin/dashboard/bot-chats/list');
            if (res.ok) {
                chats = await res.json();
                displayChats();
            } else {
                document.getElementById('chatsList').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
        } catch (error) {
            console.error('Error loading chats:', error);
            document.getElementById('chatsList').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        }
    }
    
    function displayChats() {
        const container = document.getElementById('chatsList');
        
        if (chats.length === 0) {
            container.innerHTML = '<div class="text-center">–ù–µ—Ç —á–∞—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —á–∞—Ç.</div>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¢–∏–ø</th><th>–§–∏–ª—å—Ç—Ä—ã</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
        
        chats.forEach(chat => {
            const filters = chat.filters_json || {};
            let filtersText = '';
            
            if (filters.rooms_types && filters.rooms_types.length > 0) {
                filtersText += `–ö–æ–º–Ω–∞—Ç—ã: ${filters.rooms_types.join(', ')}<br>`;
            }
            if (filters.districts && filters.districts.length > 0) {
                filtersText += `–†–∞–π–æ–Ω—ã: ${filters.districts.join(', ')}<br>`;
            }
            if (filters.price_min || filters.price_max) {
                filtersText += `–¶–µ–Ω–∞: ${filters.price_min || 0} - ${filters.price_max || '‚àû'}`;
            }
            if (!filtersText) {
                filtersText = chat.category || '–ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤';
            }
            
            html += `<tr>
                <td><strong>${chat.title}</strong><br><small>${chat.telegram_chat_id}</small></td>
                <td>${chat.type}</td>
                <td><small>${filtersText}</small></td>
                <td>${chat.is_active ? '<span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>' : '<span class="badge badge-danger">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editChat(${chat.chat_id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteChat(${chat.chat_id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
    
    function showAddChatModal() {
        document.getElementById('addChatModal').style.display = 'block';
        document.getElementById('chatLink').focus();
    }
    
    function hideAddChatModal() {
        document.getElementById('addChatModal').style.display = 'none';
        document.getElementById('addChatForm').reset();
        document.getElementById('filterFields').innerHTML = '';
    }
    
    function updateFilterFields() {
        const filterType = document.getElementById('filterType').value;
        const container = document.getElementById('filterFields');
        container.innerHTML = '';
        
        if (!config) {
            container.innerHTML = '<div class="alert alert-danger">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>';
            return;
        }
        
        if (filterType === 'rooms') {
            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø—ã –∫–æ–º–Ω–∞—Ç</label>
                    <div class="d-flex flex-wrap gap-2">
                        ${config.rooms_types.map(rt => `
                            <label class="form-check-label">
                                <input type="checkbox" name="rooms_types" value="${rt}" class="form-check-input">
                                ${rt}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        } else if (filterType === 'district') {
            const districts = Object.keys(config.districts || {});
            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">–†–∞–π–æ–Ω—ã</label>
                    <select class="form-control" name="districts" multiple>
                        ${districts.map(d => `<option value="${d}">${d}</option>`).join('')}
                    </select>
                    <small class="form-text text-muted">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö</small>
                </div>
            `;
        } else if (filterType === 'price') {
            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (—Ç—ã—Å. —Ä—É–±.)</label>
                    <input type="number" class="form-control" name="price_min" min="0" step="100">
                </div>
                <div class="form-group">
                    <label class="form-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (—Ç—ã—Å. —Ä—É–±.)</label>
                    <input type="number" class="form-control" name="price_max" min="0" step="100">
                </div>
            `;
        } else if (filterType === 'custom') {
            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">JSON —Ñ–∏–ª—å—Ç—Ä—ã</label>
                    <textarea class="form-control" name="filters_json" rows="4" placeholder='{"rooms_types": ["1–∫"], "districts": ["–ö–ö–ë"], "price_min": 3000, "price_max": 5000}'></textarea>
                </div>
            `;
        }
    }
    
    document.getElementById('addChatForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const chatLink = document.getElementById('chatLink').value.trim();
        const filterType = document.getElementById('filterType').value;
        
        if (!chatLink || !filterType) {
            showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }
        
        let filters = {};
        
        if (filterType === 'rooms') {
            const checked = Array.from(document.querySelectorAll('input[name="rooms_types"]:checked'));
            filters.rooms_types = checked.map(c => c.value);
        } else if (filterType === 'district') {
            const selected = Array.from(document.querySelectorAll('select[name="districts"] option:checked'));
            filters.districts = selected.map(s => s.value);
        } else if (filterType === 'price') {
            filters.price_min = parseFloat(document.querySelector('input[name="price_min"]').value) || null;
            filters.price_max = parseFloat(document.querySelector('input[name="price_max"]').value) || null;
        } else if (filterType === 'custom') {
            try {
                filters = JSON.parse(document.querySelector('textarea[name="filters_json"]').value);
            } catch (e) {
                showError('–ù–µ–≤–µ—Ä–Ω—ã–π JSON —Ñ–æ—Ä–º–∞—Ç');
                return;
            }
        }
        
        try {
            const res = await apiFetch('/admin/dashboard/bot-chats', {
                method: 'POST',
                body: JSON.stringify({
                    chat_link: chatLink,
                    filters: filters
                })
            });
            
            if (res.ok) {
                showSuccess('–ß–∞—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');
                hideAddChatModal();
                loadChats();
            } else {
                const data = await res.json();
                showError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —á–∞—Ç–∞');
            }
        } catch (error) {
            showError('–û—à–∏–±–∫–∞: ' + error.message);
        }
    });
    
    async function editChat(chatId) {
        const chat = chats.find(c => c.chat_id === chatId);
        if (!chat) return;
        
        // TODO: Implement edit modal
        alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Ç–∞ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
    }
    
    async function deleteChat(chatId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) return;
        
        try {
            const res = await apiFetch(`/admin/dashboard/bot-chats/${chatId}`, {
                method: 'DELETE'
            });
            
            if (res.ok) {
                showSuccess('–ß–∞—Ç —É–¥–∞–ª–µ–Ω');
                loadChats();
            } else {
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
            }
        } catch (error) {
            showError('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }
    
    function showError(msg) {
        const el = document.getElementById('error');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }
    
    function showSuccess(msg) {
        const el = document.getElementById('success');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }
    
    loadConfig();
    loadChats();
</script>
{% endblock %}

