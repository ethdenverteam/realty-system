# Инструкция по развертыванию

## 🏗 Архитектура системы

```
┌─────────────────┐
│   Пользователь  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Nginx :80      │  ← Основной веб-сервер
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌──────────┐
│ Flask  │ │  Static │  ← React приложение
│ :5000  │ │  files  │
└────────┘ └──────────┘
```

## 📋 Что у вас сейчас

1. **Grafana на порту 3000** - мониторинг (логин: `admin`, пароль: из `GRAFANA_PASSWORD` или `admin`)
2. **Nginx на порту 80** - проксирует запросы к Flask
3. **Flask на порту 5000** - API и отдача статики
4. **React приложение** - собрано в `static/`

## ✅ Правильная последовательность развертывания

### 1. Соберите React приложение

```bash
cd frontend
npm install
npm run build
```

Это создаст файлы в `../static/` (в корне проекта).

### 2. Запустите Docker Compose

```bash
# Из корня проекта (не из frontend!)
cd ~/realty-system
docker-compose up -d
```

### 3. Проверьте что работает

- `http://31.130.144.220` - ваше приложение (landing page)
- `http://31.130.144.220/login` - страница входа
- `http://31.130.144.220/system/*` - API эндпоинты
- `http://31.130.144.220:3000` - Grafana (мониторинг)

## 🔧 Что происходит

1. **Пользователь заходит на `http://31.130.144.220`**
   - Nginx получает запрос на порт 80
   - Проксирует его в Flask контейнер (порт 5000)
   - Flask проверяет путь:
     - Если `/system/*` → обрабатывает как API
     - Если статический файл (JS/CSS) → отдает из `static/`
     - Иначе → отдает `static/index.html` (React Router)

2. **React приложение загружается**
   - `index.html` загружается
   - React Router определяет маршрут (`/`, `/login`, `/admin/dashboard`, etc.)
   - Отображает нужный компонент

3. **API запросы**
   - Все запросы к `/system/*` идут в Flask
   - Flask обрабатывает их и возвращает JSON

## 🚨 Проблемы которые были

1. **Вы запускали `npm run dev`** - это только для разработки, не нужно в продакшене
2. **Вы пытались запустить Flask вручную** - он уже работает в Docker
3. **Порт 3001 не открыт** - потому что это локальный dev-сервер, не нужен в продакшене

## 📝 Обновление приложения

Когда нужно обновить frontend:

```bash
cd frontend
npm run build
docker-compose restart web nginx
```

## 🔐 Grafana

Grafana доступна на `http://31.130.144.220:3000`

Логин: `admin`  
Пароль: значение из переменной окружения `GRAFANA_PASSWORD` или `admin` по умолчанию

Чтобы изменить пароль, добавьте в `.env`:
```
GRAFANA_PASSWORD=ваш_пароль
```

## 🎯 Итоговая структура URL

- `http://31.130.144.220/` → Landing page (приветственная)
- `http://31.130.144.220/login` → Вход в систему
- `http://31.130.144.220/admin/dashboard` → Админ панель
- `http://31.130.144.220/user/dashboard` → Пользовательская панель
- `http://31.130.144.220/system/*` → API эндпоинты
- `http://31.130.144.220:3000` → Grafana (мониторинг)

