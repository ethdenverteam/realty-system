# ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏ - –ó–ê–í–ï–†–®–ï–ù

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. ‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ë–î
**–§–∞–π–ª:** `scripts/check_queues.py`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
docker exec -it realty_web python scripts/check_queues.py [object_id] [account_phone]
```

### 2. ‚úÖ –í—ã–Ω–µ—Å–µ–Ω –¥–≤–∏–∂–æ–∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ –µ–¥–∏–Ω—É—é —É—Ç–∏–ª–∏—Ç—É
**–§–∞–π–ª:** `app/utils/account_publication_utils.py`

**–ü–æ–¥–¥–µ—Ä–∂–∫–∞ 5 —Ä–µ–∂–∏–º–æ–≤:**
- `safe`: 10 –º–∏–Ω—É—Ç + –¥–∂–∏—Ç—Ç–µ—Ä (1-99 —Å–µ–∫)
- `normal`: 5 –º–∏–Ω—É—Ç + –¥–∂–∏—Ç—Ç–µ—Ä
- `aggressive`: 2 –º–∏–Ω—É—Ç—ã + –¥–∂–∏—Ç—Ç–µ—Ä
- `smart`: —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å (8:00-22:00 –ú–°–ö)
- `fix`: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∏–∑ `TelegramAccount.fix_interval_minutes`) + –¥–∂–∏—Ç—Ç–µ—Ä

### 3. ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
**–§–∞–π–ª:** `app/utils/duplicate_checker.py`

**4 —Ç–∏–ø–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π:**
- `manual_bot` - —Ä—É—á–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- `manual_account` - —Ä—É—á–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç
- `autopublish_bot` - –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- `autopublish_account` - –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç

**+ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¥–ª—è –∞–¥–º–∏–Ω–æ–≤:** `admin_bypass`

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:** `SystemSetting` —Å –∫–ª—é—á–æ–º `allow_duplicates`

### 4. ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á
**–§–∞–π–ª:** `workers/tasks.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `schedule_daily_autopublish()` - —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á–∏
- `process_account_autopublish()` - —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `duplicate_checker` –≤–º–µ—Å—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `fix_interval_minutes` –¥–ª—è —Ä–µ–∂–∏–º–∞ 'fix'

### 5. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ä—É—á–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç—ã
**–§–∞–π–ª:** `app/routes/account_publications.py`

**Endpoint:** `POST /system/account-publications/manual`

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç rate limiter —á–µ—Ä–µ–∑ `get_rate_limit_status()`
2. –ï—Å–ª–∏ –Ω–µ –≥–æ—Ç–æ–≤ - –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç –Ω–∞ 30 –º–∏–Ω—É—Ç + –¥–∂–∏—Ç—Ç–µ—Ä
3. –ï—Å–ª–∏ –≥–æ—Ç–æ–≤ - –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–µ–π—á–∞—Å
4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ `duplicate_checker`
5. –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∑–∞–¥–∞—á–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É –∞–∫–∫–∞—É–Ω—Ç–∞

### 6. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–¥–∞—á
**–§–∞–π–ª:** `workers/tasks.py` ‚Üí `schedule_daily_autopublish()`

**–õ–æ–≥–∏–∫–∞:**
- –°–Ω–∞—á–∞–ª–∞ –≤—Å–µ —á–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, –ø–æ—Ç–æ–º –≤—Ç–æ—Ä–æ–≥–æ –∏ —Ç.–¥.
- –ó–∞–¥–∞—á–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º
- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º —Ä–µ–∂–∏–º–∞ –∞–∫–∫–∞—É–Ω—Ç–∞

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
1. `scripts/check_queues.py` - —Å–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
2. `app/utils/duplicate_checker.py` - —É—Ç–∏–ª–∏—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
3. `app/routes/account_publications.py` - —Ä—É—á–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç—ã
4. `migrations/versions/add_fix_interval_to_telegram_account.py` - –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
5. `DIAGNOSTIC_QUEUES.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ
6. `REFACTORING_QUEUES_SUMMARY.md` - —Ä–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `app/utils/account_publication_utils.py` - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 5 —Ä–µ–∂–∏–º–æ–≤ + –¥–∂–∏—Ç—Ç–µ—Ä
2. `app/models/telegram_account.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `fix_interval_minutes`
3. `workers/tasks.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `duplicate_checker`, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `fix_interval_minutes`
4. `app/routes/publications.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `duplicate_checker`
5. `app/__init__.py` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ blueprint

## üìù –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
```bash
docker exec -it realty_web alembic upgrade head
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Celery
```bash
docker compose restart celery_worker celery_beat
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–µ—Ä–µ–¥–∏
docker exec -it realty_web python scripts/check_queues.py AAA052 +79996731791

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á
docker exec -it realty_celery_worker celery -A workers.celery_app call workers.tasks.schedule_daily_autopublish

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
docker exec -it realty_celery_worker celery -A workers.celery_app call workers.tasks.process_account_autopublish
```

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å Docker

**–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ:**
```
target web: failed to solve: failed to prepare extraction snapshot
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à Docker
docker builder prune -a

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –±–µ–∑ –∫–µ—à–∞
docker compose build --no-cache

# –ò–ª–∏ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å
docker compose build --no-cache web celery_worker celery_beat bot
```

## üîç –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏ Celery

–ï—Å–ª–∏ `celery_worker` –∏ `celery_beat` –≤ —Å—Ç–∞—Ç—É—Å–µ "Restarting":

```bash
# –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏
docker logs realty_celery_worker --tail 100
docker logs realty_celery_beat --tail 100

# –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
# 1. –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
# 2. –ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î/Redis
# 3. –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ –∑–∞–¥–∞—á
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞:**
```bash
docker compose restart celery_worker celery_beat
```

## üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤–∏–ª –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å `SystemSetting`:

```sql
INSERT INTO system_settings (key, value_json, description, updated_at)
VALUES (
    'allow_duplicates',
    '{
        "manual_bot": false,
        "manual_account": false,
        "autopublish_bot": false,
        "autopublish_account": false,
        "admin_bypass": false
    }',
    '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—É–±–ª–∏–∫–∞—Ü–∏–π',
    NOW()
)
ON CONFLICT (key) DO UPDATE
SET value_json = EXCLUDED.value_json,
    updated_at = NOW();
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
2. ‚úÖ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
3. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Celery
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–±—ä–µ–∫—Ç–µ AAA052
5. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

