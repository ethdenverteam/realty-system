# Логи и мониторинг

## Просмотр логов в Portainer

### Логи веб-приложения (app)

1. Откройте Portainer: `http://your-server:9000`
2. Перейдите в **Containers**
3. Найдите контейнер с веб-приложением (обычно `realty-system-web` или похожее)
4. Нажмите на контейнер
5. Перейдите на вкладку **Logs**
6. Вы увидите логи в реальном времени

### Логи бота

1. В Portainer найдите контейнер бота (обычно `realty-system-bot`)
2. Откройте его и перейдите на вкладку **Logs**

### Альтернативный способ через Docker

```bash
# Логи веб-приложения
docker logs -f realty-system-web

# Логи бота
docker logs -f realty-system-bot

# Последние 100 строк
docker logs --tail 100 realty-system-web
```

## Файлы логов на сервере

Логи также сохраняются в файлы в папке `logs/`:

- `logs/app.log` - все логи веб-приложения
- `logs/errors.log` - только ошибки веб-приложения
- `logs/bot.log` - все логи бота
- `logs/bot_errors.log` - только ошибки бота

## Мониторинг в Grafana

### Что можно отслеживать:

1. **Метрики приложения** (если настроен Prometheus):
   - Количество запросов
   - Время ответа
   - Количество ошибок
   - Использование памяти и CPU

2. **Метрики базы данных**:
   - Количество подключений
   - Размер базы данных
   - Медленные запросы

3. **Метрики системы**:
   - Использование CPU, RAM, диска
   - Сетевая активность
   - Количество контейнеров

### Настройка Grafana для мониторинга:

1. Добавьте Prometheus как источник данных в Grafana
2. Создайте дашборды для отслеживания:
   - Метрики приложения (если настроен `/metrics` endpoint)
   - Метрики Docker контейнеров
   - Метрики PostgreSQL

## Проблема: Conflict: terminated by other getUpdates request

Эта ошибка возникает, когда **запущено несколько экземпляров бота одновременно**.

### Решение:

1. **Проверьте, сколько контейнеров бота запущено:**
   ```bash
   docker ps | grep bot
   ```

2. **Остановите лишние экземпляры:**
   ```bash
   docker stop <container_id>
   ```

3. **Проверьте docker-compose.yml:**
   - Убедитесь, что сервис бота запускается только один раз
   - Проверьте, нет ли дублирующихся сервисов

4. **Проверьте процессы:**
   ```bash
   ps aux | grep bot
   ```

5. **Перезапустите бота:**
   ```bash
   docker-compose restart bot
   ```

## Получение чатов бота

Когда вы нажимаете "Получить чаты", происходит:

1. Запрос к Telegram API: `getUpdates`
2. Получение всех обновлений (сообщений), которые бот получил
3. Извлечение информации о чатах из обновлений
4. Разделение на группы и пользователей
5. Отображение списка

### Если не работает:

1. **Проверьте токен бота** в переменных окружения
2. **Проверьте, что бот запущен** и работает
3. **Проверьте логи** в админ-панели или Portainer
4. **Убедитесь, что бот получал сообщения** (если бот новый, отправьте ему сообщение)

### Отладка:

Логи получения чатов теперь выводятся в:
- Логи веб-приложения (`logs/app.log`)
- Консоль браузера (F12 → Console)
- Админ-панель → Логи

