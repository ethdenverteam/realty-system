import axios from 'axios'
import { useEffect, useState } from 'react'
import { Link } from 'react-router-dom'
import Layout from '../../components/Layout'
import { useAuth } from '../../contexts/AuthContext'
import api from '../../utils/api'
import type { UserStats, ApiErrorResponse } from '../../types/models'
import './Dashboard.css'

export default function UserDashboard(): JSX.Element {
  const { user } = useAuth()
  const [stats, setStats] = useState<UserStats | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState('')

  useEffect(() => {
    void loadStats()
  }, [])

  const loadStats = async (): Promise<void> => {
    try {
      const res = await api.get<UserStats>('/user/dashboard/stats')
      setStats(res.data)
    } catch (err: unknown) {
      setError('Ошибка загрузки данных')
      if (axios.isAxiosError<ApiErrorResponse>(err)) {
        console.error(err.response?.data || err.message)
      } else {
        console.error(err)
      }
    } finally {
      setLoading(false)
    }
  }

  return (
    <Layout title="Моя панель">
      <div className="dashboard-page">
        {error && <div className="alert alert-error">{error}</div>}

        <div className="stats-grid">
          <Link to="/user/dashboard/autopublish" className="stat-card" style={{ textDecoration: 'none', color: 'inherit' }}>
            <div className="stat-value">{loading ? '-' : (stats?.autopublish_objects_count ?? 0)}</div>
            <div className="stat-label">Объектов на автопубликации</div>
          </Link>
          <Link to="/user/dashboard/objects" className="stat-card" style={{ textDecoration: 'none', color: 'inherit' }}>
            <div className="stat-value">{loading ? '-' : (stats?.objects_count ?? '-')}</div>
            <div className="stat-label">Объектов всего</div>
          </Link>
        </div>

        <div className="card">
          <h2 className="card-title">Быстрые действия</h2>
          <div className="actions-grid">
            <Link to="/user/dashboard/objects/create" className="action-card">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M12 4V20M4 12H20" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
              </svg>
              <span>Создать объект</span>
            </Link>
            <Link to="/user/dashboard/objects" className="action-card">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path
                  d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z"
                  stroke="currentColor"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M9 22V12H15V22"
                  stroke="currentColor"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
              <span>Мои объекты</span>
            </Link>
            <Link to="/user/dashboard/settings" className="action-card">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path
                  d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"
                  stroke="currentColor"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M19.4 15C19.2669 15.3016 19.2272 15.6362 19.286 15.9606C19.3448 16.285 19.4995 16.5843 19.73 16.82L19.79 16.88C19.976 17.0657 20.1235 17.2863 20.2241 17.5291C20.3248 17.7719 20.3766 18.0322 20.3766 18.295C20.3766 18.5578 20.3248 18.8181 20.2241 19.0609C20.1235 19.3037 19.976 19.5243 19.79 19.71L19.73 19.77C19.4943 20.0005 19.195 20.1552 18.8706 20.214C18.5462 20.2728 18.2116 20.2331 17.91 20.1C17.6084 19.9669 17.3534 19.7462 17.18 19.47L17.12 19.41C16.9972 19.2038 16.8362 19.0272 16.6464 18.8904C16.4566 18.7536 16.242 18.6596 16.015 18.615L15.945 18.6C15.682 18.555 15.409 18.555 15.146 18.6L15.076 18.615C14.849 18.6596 14.6344 18.7536 14.4446 18.8904C14.2548 19.0272 14.0938 19.2038 13.971 19.41L13.911 19.47C13.7376 19.7462 13.4826 19.9669 13.181 20.1C12.8794 20.2331 12.5448 20.2728 12.2204 20.214C11.896 20.1552 11.5967 20.0005 11.366 19.77L11.306 19.71C11.12 19.5243 10.9725 19.3037 10.8719 19.0609C10.7712 18.8181 10.7194 18.5578 10.7194 18.295C10.7194 18.0322 10.7712 17.7719 10.8719 17.5291C10.9725 17.2863 11.12 17.0657 11.306 16.88L11.366 16.82C11.5967 16.5843 11.896 16.285 12.2204 16.2262C12.5448 16.1674 12.8794 16.2071 13.181 16.34C13.4826 16.4731 13.7376 16.6938 13.911 16.97L13.971 17.03C14.0938 17.2362 14.2548 17.4128 14.4446 17.5496C14.6344 17.6864 14.849 17.7804 15.076 17.825L15.146 17.84C15.409 17.885 15.682 17.885 15.945 17.84L16.015 17.825C16.242 17.7804 16.4566 17.6864 16.6464 17.5496C16.8362 17.4128 16.9972 17.2362 17.12 17.03L17.18 16.97C17.3534 16.6938 17.6084 16.4731 17.91 16.34C18.2116 16.2071 18.5462 16.1674 18.8706 16.2262C19.195 16.285 19.4943 16.5843 19.73 16.82L19.79 16.88C19.976 17.0657 20.1235 17.2863 20.2241 17.5291C20.3248 17.7719 20.3766 18.0322 20.3766 18.295C20.3766 18.5578 20.3248 18.8181 20.2241 19.0609C20.1235 19.3037 19.976 19.5243 19.79 19.71L19.73 19.77C19.4943 20.0005 19.195 20.1552 18.8706 20.214C18.5462 20.2728 18.2116 20.2331 17.91 20.1H17.82C17.6084 20.2331 17.3534 20.4538 17.18 20.73L17.12 20.79C16.9972 20.9962 16.8362 21.1728 16.6464 21.3096C16.4566 21.4464 16.242 21.5404 16.015 21.585L15.945 21.6C15.682 21.645 15.409 21.645 15.146 21.6L15.076 21.585C14.849 21.5404 14.6344 21.4464 14.4446 21.3096C14.2548 21.1728 14.0938 20.9962 13.971 20.79L13.911 20.73C13.7376 20.4538 13.4826 20.2331 13.181 20.1C12.8794 19.9669 12.5448 19.9272 12.2204 19.986C11.896 20.0448 11.5967 20.1995 11.366 20.43L11.306 20.49C11.12 20.6757 10.9725 20.8963 10.8719 21.1391C10.7712 21.3819 10.7194 21.6422 10.7194 21.905C10.7194 22.1678 10.7712 22.4281 10.8719 22.6709C10.9725 22.9137 11.12 23.1343 11.306 23.32L11.366 23.38C11.5967 23.6105 11.896 23.7652 12.2204 23.824C12.5448 23.8828 12.8794 23.8431 13.181 23.71C13.4826 23.5769 13.7376 23.3562 13.911 23.08L13.971 23.02C14.0938 22.8138 14.2548 22.6372 14.4446 22.5004C14.6344 22.3636 14.849 22.2696 15.076 22.225L15.146 22.21C15.409 22.165 15.682 22.165 15.945 22.21L16.015 22.225C16.242 22.2696 16.4566 22.3636 16.6464 22.5004C16.8362 22.6372 16.9972 22.8138 17.12 23.02L17.18 23.08C17.3534 23.3562 17.6084 23.5769 17.91 23.71C18.2116 23.8431 18.5462 23.8828 18.8706 23.824C19.195 23.7652 19.4943 23.6105 19.73 23.38L19.79 23.32C19.976 23.1343 20.1235 22.9137 20.2241 22.6709C20.3248 22.4281 20.3766 22.1678 20.3766 21.905C20.3766 21.6422 20.3248 21.3819 20.2241 21.1391C20.1235 20.8963 19.976 20.6757 19.79 20.49L19.73 20.43C19.4943 20.1995 19.195 20.0448 18.8706 19.986C18.5462 19.9272 18.2116 19.9669 17.91 20.1L17.82 20.1C17.6084 20.2331 17.3534 20.4538 17.18 20.73L17.12 20.79C16.9972 20.9962 16.8362 21.1728 16.6464 21.3096C16.4566 21.4464 16.242 21.5404 16.015 21.585L15.945 21.6C15.682 21.645 15.409 21.645 15.146 21.6L15.076 21.585C14.849 21.5404 14.6344 21.4464 14.4446 21.3096C14.2548 21.1728 14.0938 20.9962 13.971 20.79L13.911 20.73C13.7376 20.4538 13.4826 20.2331 13.181 20.1C12.8794 19.9669 12.5448 19.9272 12.2204 19.986C11.896 20.0448 11.5967 20.1995 11.366 20.43L11.306 20.49C11.12 20.6757 10.9725 20.8963 10.8719 21.1391C10.7712 21.3819 10.7194 21.6422 10.7194 21.905C10.7194 22.1678 10.7712 22.4281 10.8719 22.6709C10.9725 22.9137 11.12 23.1343 11.306 23.32L11.366 23.38C11.5967 23.6105 11.896 23.7652 12.2204 23.824C12.5448 23.8828 12.8794 23.8431 13.181 23.71C13.4826 23.5769 13.7376 23.3562 13.911 23.08L13.971 23.02C14.0938 22.8138 14.2548 22.6372 14.4446 22.5004C14.6344 22.3636 14.849 22.2696 15.076 22.225L15.146 22.21C15.409 22.165 15.682 22.165 15.945 22.21L16.015 22.225C16.242 22.2696 16.4566 22.3636 16.6464 22.5004C16.8362 22.6372 16.9972 22.8138 17.12 23.02L17.18 23.08C17.3534 23.3562 17.6084 23.5769 17.91 23.71C18.2116 23.8431 18.5462 23.8828 18.8706 23.824C19.195 23.7652 19.4943 23.6105 19.73 23.38L19.79 23.32C19.976 23.1343 20.1235 22.9137 20.2241 22.6709C20.3248 22.4281 20.3766 22.1678 20.3766 21.905C20.3766 21.6422 20.3248 21.3819 20.2241 21.1391C20.1235 20.8963 19.976 20.6757 19.79 20.49L19.73 20.43C19.4943 20.1995 19.195 20.0448 18.8706 19.986C18.5462 19.9272 18.2116 19.9669 17.91 20.1H17.82"
                  stroke="currentColor"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
              <span>Настройки</span>
            </Link>
          </div>
        </div>

        {user?.web_role === 'admin' && (
          <div className="card">
            <h2 className="card-title">Админ функции</h2>
            <Link to="/admin/dashboard" className="action-card">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path
                  d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"
                  stroke="currentColor"
                  strokeWidth="2"
                />
                <path d="M12 8V12M12 16H12.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
              </svg>
              <span>Админ панель</span>
            </Link>
          </div>
        )}
      </div>
    </Layout>
  )
}


