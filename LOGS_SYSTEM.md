# Система логирования Realty System

## Архитектура логирования

Система использует **двухуровневое логирование**:

### 1. Production логи (постоянные, ротирующиеся)
- `app.log` - все логи приложения (10MB, 10 файлов)
- `errors.log` - только ошибки (5MB, 5 файлов)
- `bot.log` - все логи бота (10MB, 10 файлов)
- `bot_errors.log` - ошибки бота (5MB, 5 файлов)

**Назначение:** Полная история работы системы

### 2. Test логи (очищаются при деплое, для AI анализа)
- `test_app.log` - логи приложения с последнего деплоя
- `test_errors.log` - ошибки с последнего деплоя
- `test_database.log` - операции с БД
- `test_api.log` - API запросы/ответы
- `test_celery.log` - задачи Celery
- `test_bot.log` - логи бота с последнего деплоя
- `test_bot_errors.log` - ошибки бота с последнего деплоя

**Назначение:** Короткие, свежие логи для анализа AI после тестирования

## Как это работает

### При деплое (`deploy.sh`):
1. Очищаются все `test_*.log` файлы
2. Контейнеры перезапускаются
3. Начинается новая сессия тестирования

### При тестировании:
- Все события пишутся в `test_*.log` файлы
- Логи остаются короткими (только с текущей сессии)
- AI получает только релевантные данные

### При скачивании логов:
- Скрипт `download_logs.py` скачивает только `test_*.log`
- Логи попадают в `logs_server/` на локальном компьютере
- AI анализирует короткие, свежие логи

## Настройка LOGS_DOWNLOAD_TOKEN

### На сервере (в `.env` или `docker-compose.yml`):

```bash
LOGS_DOWNLOAD_TOKEN=your_secure_token_here_12345
```

**Важно:** Это отдельный токен, не JWT! Он не истекает и используется только для скачивания логов.

### На локальном компьютере:

Создайте файл `.api_token` в корне проекта:
```
your_secure_token_here_12345
```

Или установите переменную окружения:
```bash
export REALTY_LOGS_DOWNLOAD_TOKEN="your_secure_token_here_12345"
```

## Расширенное логирование

Система логирует:

1. **Приложение (app.log / test_app.log)**
   - Все события приложения
   - Действия пользователей
   - Общая информация

2. **Ошибки (errors.log / test_errors.log)**
   - Все исключения и ошибки
   - Stack traces
   - Критические события

3. **База данных (test_database.log)**
   - SQL запросы
   - Транзакции
   - Операции с моделями

4. **API (test_api.log)**
   - HTTP запросы
   - Ответы сервера
   - Параметры запросов

5. **Celery (test_celery.log)**
   - Задачи в очереди
   - Результаты выполнения
   - Ошибки задач

6. **Бот (bot.log / test_bot.log)**
   - События бота
   - Обработка команд
   - Взаимодействие с пользователями

7. **Ошибки бота (bot_errors.log / test_bot_errors.log)**
   - Исключения в боте
   - Проблемы с Telegram API

## Использование

### Скачать тестовые логи (для AI):

```bash
python download_logs.py https://your-domain.com
```

Логи появятся в `logs_server/`:
```
logs_server/
├── test_app.log
├── test_errors.log
├── test_database.log
├── test_api.log
├── test_celery.log
├── test_bot.log
└── test_bot_errors.log
```

### Скачать production логи (ZIP через веб):

1. Откройте `/admin/dashboard/logs`
2. Нажмите "⬇️ Скачать логи"
3. Получите ZIP с полной историей

## Преимущества системы

✅ **Короткие логи для AI** - только релевантные данные  
✅ **Автоматическая очистка** - свежий старт при каждом деплое  
✅ **Расширенное логирование** - все процессы на сервере  
✅ **Безопасность** - отдельный токен для скачивания  
✅ **Удобство** - простой скрипт для получения логов  

## Рекомендации

1. **Перед деплоем:** Скачайте тестовые логи для анализа
2. **После деплоя:** Логи автоматически очищаются
3. **При проблемах:** Используйте `test_errors.log` для быстрого анализа
4. **Для истории:** Используйте production логи (`app.log`, `errors.log`)

